---
- hosts: localhost
  tasks:
  - name: Import certificate file
    include_vars: ../../keys/digitalocean.yaml
    no_log: True
  - name: Ensure domain is presemt
    digital_ocean_domain:
      api_token: '{{ digital_ocean_api_key }}'
      state: present
      name: fale.io
      ip: 127.0.0.1
  - name: Add the SSH Key to Digital Ocean
    digital_ocean:
      state: present
      command: ssh
      name: 'fale@redhat.com'
      ssh_pub_key: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDCQiNk2aenh+lRsEY9mV9774jK77TRlDyserwRvv12dHcof2okUOaF2YQH2MnTtgxakjaxxwqeI3di66osa95dhHsujhFueLkZpzteNsafaDE/Da4jC9sPmYSAlpS6VneHIzEqGAOTWjShMyKaMByg0i0Jdte/NJQbpvbSSb7wqDWx/ByzSNElxJO9HL+XL/ythHXI1NylQ3Fjr8dtFnXU3n8kp9/aIt9Kqzum27avQ0ePpS5YE2x7bXaFl2qHYvOxN/dVF8KdQfJP7vBX1Qv0s9b2SOP08+EQHmNetaYcHobo8GSWo5xBM51Ar1gBu+8ON72C6y4r0HdzCCGkteZeiIYEKFjkjISeDElywmir58WsZYtJiYVlwjSAVUrNWCjjJziMIrGw70Md+w/oFw2VEQQGJIMxTzIL8necRXBxLE5WMnRLRqHmh+vkkZOP6CnI1YU+jsT/FTW4/KMKZ8tszeCW7EDaTGCTy+skzMko++fDQDUEN3D2w+zByMP/UShf+lVp2XNYHYbsZIO6cR2HRJYEjtE9y+WWgrTS8TnFJWhNseScKIomOuaN0eJGjuuqGyMoaDoUA1zkuc103AW8UTVaWJW+8pZKgOltrYrfgLCQB6D7EEunPjYs9qaAh7Y02VJKbRcoBqSBlxajILVd2gdUQkQxIX9ynRxHDqmMuQ=='
      api_token: '{{ digital_ocean_api_key }}'
    register: ssh_key
  - name: Ensure the triba exists
    digital_ocean:
      state: present
      ssh_key_ids: '{{ ssh_key.ssh_key.id }}'
      name: '{{ item.name }}'
      api_token: '{{ digital_ocean_api_key }}'
      size_id: 512mb
      region_id: '{{ item.region }}'
      image_id: fedora-24-x64
      unique_name: True
      private_networking: '{{ item.private_networking }}'
      #ipv6: True # Waiting for https://github.com/ansible/ansible-modules-core/pull/2579
    with_items:
    # European DCs: lon1, ams2, ams3, fra1
    - name: bob.fale.io
      region: lon1
      private_networking: True
    - name: kevin.fale.io
      region: lon1
      private_networking: True
    - name: stuart.fale.io
      region: lon1
      private_networking: True
    register: droplets
  - name: Ensure domain resolve properly
    digital_ocean_domain:
      api_token: '{{ digital_ocean_api_key }}'
      state: present
      name: '{{ item.droplet.name }}'
      ip: '{{ item.droplet.ip_address }}'
    with_items: '{{ droplets.results }}'
